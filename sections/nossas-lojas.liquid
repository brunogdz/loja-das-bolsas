<div class="page-width page-width--narrow section-{{ section.id }}-padding">
  <div class="stores-finder">
    <div class="stores-cep-info" id="cep-info-{{ section.id }}" style="display: none;">
      <div class="cep-result">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
          <path d="M10 0C6.13 0 3 3.13 3 7C3 12.25 10 20 10 20C10 20 17 12.25 17 7C17 3.13 13.87 0 10 0ZM10 9.5C8.62 9.5 7.5 8.38 7.5 7C7.5 5.62 8.62 4.5 10 4.5C11.38 4.5 12.5 5.62 12.5 7C12.5 8.38 11.38 9.5 10 9.5Z" fill="#7C3AED"/>
        </svg>
        <div>
          <strong>Sua localização:</strong>
          <span id="user-location-{{ section.id }}"></span>
        </div>
      </div>
    </div>

    <div class="stores-list" id="stores-list-{{ section.id }}">
      <div
        class="store-card"
        data-store="loja1"
        data-lat="-20.676700"
        data-lng="-40.497600"
      >
        <div class="store-badge" style="display: none;">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path d="M8 1L10.5 6L16 6.75L12 10.5L13 16L8 13.25L3 16L4 10.5L0 6.75L5.5 6L8 1Z" fill="#FFB800"/>
          </svg>
          <span class="store-distance"></span>
        </div>

        <div class="store-header">
          <h3 class="store-name">Loja 1 - Centro</h3>
          <div class="store-managers">Com Rildo e Suely</div>
        </div>

        <div class="store-body">
          <div class="store-address">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
              <path d="M8 1C5.24 1 3 3.24 3 6C3 9.5 8 15 8 15C8 15 13 9.5 13 6C13 3.24 10.76 1 8 1ZM8 7.5C7.17 7.5 6.5 6.83 6.5 6C6.5 5.17 7.17 4.5 8 4.5C8.83 4.5 9.5 5.17 9.5 6C9.5 6.83 8.83 7.5 8 7.5Z" fill="#666"/>
            </svg>
            <span>Rua do Trabalho, 65, Centro - Guarapari/ES</span>
          </div>

          <div class="store-description">
            Já são mais de 20 anos vendendo milhares de bolsas com tradição e qualidade.
          </div>

          <div class="store-actions">
            <a
              href="https://wa.me/5527999999999?text=Olá! Vi a loja 1 no site e gostaria de saber mais."
              class="store-btn store-btn--whatsapp"
              target="_blank"
              rel="noopener"
            >
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <path d="M10 0C4.477 0 0 4.477 0 10C0 11.89 0.525 13.66 1.438 15.168L0.546 18.2C0.492 18.389 0.542 18.593 0.677 18.733C0.782 18.842 0.925 18.9 1.071 18.9C1.118 18.9 1.166 18.894 1.213 18.882L4.406 18.078C5.848 18.944 7.448 19.4 9.1 19.4C14.523 19.4 18.9 14.923 18.9 9.4C18.9 3.877 14.423 0 9.9 0H10Z" fill="#25D366"/>
              </svg>
              WhatsApp
            </a>
            <a
              href="https://www.google.com/maps/dir/?api=1&destination=Rua+do+Trabalho+65+Centro+Guarapari+ES"
              class="store-btn store-btn--directions"
              target="_blank"
              rel="noopener"
            >
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <path d="M10 3V17M10 3L6 7M10 3L14 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Como chegar
            </a>
          </div>
        </div>
      </div>

      <div
        class="store-card"
        data-store="loja2"
        data-lat="-20.674800"
        data-lng="-40.496900"
      >
        <div class="store-badge" style="display: none;">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path d="M8 1L10.5 6L16 6.75L12 10.5L13 16L8 13.25L3 16L4 10.5L0 6.75L5.5 6L8 1Z" fill="#FFB800"/>
          </svg>
          <span class="store-distance"></span>
        </div>

        <div class="store-header">
          <h3 class="store-name">Loja 2 - Centro</h3>
          <div class="store-managers">Com Isabel Cristina</div>
        </div>

        <div class="store-body">
          <div class="store-address">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
              <path d="M8 1C5.24 1 3 3.24 3 6C3 9.5 8 15 8 15C8 15 13 9.5 13 6C13 3.24 10.76 1 8 1ZM8 7.5C7.17 7.5 6.5 6.83 6.5 6C6.5 5.17 7.17 4.5 8 4.5C8.83 4.5 9.5 5.17 9.5 6C9.5 6.83 8.83 7.5 8 7.5Z" fill="#666"/>
            </svg>
            <span>Rua Pedro Caetano, 94, Centro - Guarapari/ES</span>
          </div>

          <div class="store-description">
            Referência em sofisticação e beleza, com atendimento personalizado e produtos exclusivos.
          </div>

          <div class="store-actions">
            <a
              href="https://wa.me/5527988888888?text=Olá! Vi a loja 2 no site e gostaria de saber mais."
              class="store-btn store-btn--whatsapp"
              target="_blank"
              rel="noopener"
            >
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <path d="M10 0C4.477 0 0 4.477 0 10C0 11.89 0.525 13.66 1.438 15.168L0.546 18.2C0.492 18.389 0.542 18.593 0.677 18.733C0.782 18.842 0.925 18.9 1.071 18.9C1.118 18.9 1.166 18.894 1.213 18.882L4.406 18.078C5.848 18.944 7.448 19.4 9.1 19.4C14.523 19.4 18.9 14.923 18.9 9.4C18.9 3.877 14.423 0 9.9 0H10Z" fill="#25D366"/>
              </svg>
              WhatsApp
            </a>
            <a
              href="https://www.google.com/maps/dir/?api=1&destination=Rua+Pedro+Caetano+94+Centro+Guarapari+ES"
              class="store-btn store-btn--directions"
              target="_blank"
              rel="noopener"
            >
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <path d="M10 3V17M10 3L6 7M10 3L14 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Como chegar
            </a>
          </div>
        </div>
      </div>

      <div
        class="store-card"
        data-store="loja3"
        data-lat="-20.652400"
        data-lng="-40.507800"
      >
        <div class="store-badge" style="display: none;">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path d="M8 1L10.5 6L16 6.75L12 10.5L13 16L8 13.25L3 16L4 10.5L0 6.75L5.5 6L8 1Z" fill="#FFB800"/>
          </svg>
          <span class="store-distance"></span>
        </div>

        <div class="store-header">
          <h3 class="store-name">Loja 3 - Muquiçaba</h3>
          <div class="store-managers">Com Patrícia</div>
        </div>

        <div class="store-body">
          <div class="store-address">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
              <path d="M8 1C5.24 1 3 3.24 3 6C3 9.5 8 15 8 15C8 15 13 9.5 13 6C13 3.24 10.76 1 8 1ZM8 7.5C7.17 7.5 6.5 6.83 6.5 6C6.5 5.17 7.17 4.5 8 4.5C8.83 4.5 9.5 5.17 9.5 6C9.5 6.83 8.83 7.5 8 7.5Z" fill="#666"/>
            </svg>
            <span>Rua Francisco Vieira Passos, 90, Muquiçaba - Guarapari/ES</span>
          </div>

          <div class="store-description">
            Nossa loja mais nova! Unindo o melhor das lojas 1 e 2 com inovação e modernidade.
          </div>

          <div class="store-actions">
            <a
              href="https://wa.me/5527977777777?text=Olá! Vi a loja 3 no site e gostaria de saber mais."
              class="store-btn store-btn--whatsapp"
              target="_blank"
              rel="noopener"
            >
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <path d="M10 0C4.477 0 0 4.477 0 10C0 11.89 0.525 13.66 1.438 15.168L0.546 18.2C0.492 18.389 0.542 18.593 0.677 18.733C0.782 18.842 0.925 18.9 1.071 18.9C1.118 18.9 1.166 18.894 1.213 18.882L4.406 18.078C5.848 18.944 7.448 19.4 9.1 19.4C14.523 19.4 18.9 14.923 18.9 9.4C18.9 3.877 14.423 0 9.9 0H10Z" fill="#25D366"/>
              </svg>
              WhatsApp
            </a>
            <a
              href="https://www.google.com/maps/dir/?api=1&destination=Rua+Francisco+Vieira+Passos+90+Muquiçaba+Guarapari+ES"
              class="store-btn store-btn--directions"
              target="_blank"
              rel="noopener"
            >
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <path d="M10 3V17M10 3L6 7M10 3L14 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Como chegar
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .stores-finder {
    margin: 40px 0;
  }

  .stores-cep-info {
    background: #f3f4f6;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 32px;
  }

  .cep-result {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .cep-result svg {
    flex-shrink: 0;
  }

  .cep-result strong {
    display: block;
    margin-bottom: 4px;
  }

  .stores-list {
    display: grid;
    gap: 24px;
  }

  .store-card {
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 16px;
    padding: 24px;
    transition: all 0.3s ease;
    position: relative;
  }

  .store-card:hover {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
  }

  .store-card.nearest {
    border-color: #7c3aed;
    box-shadow: 0 4px 16px rgba(124, 58, 237, 0.15);
  }

  .store-badge {
    position: absolute;
    top: 16px;
    right: 16px;
    background: #fef3c7;
    padding: 6px 12px;
    border-radius: 20px;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
    font-weight: 600;
    color: #92400e;
  }

  .store-header {
    margin-bottom: 16px;
  }

  .store-name {
    font-size: 24px;
    font-weight: 700;
    margin: 0 0 8px 0;
    color: #111827;
  }

  .store-managers {
    font-size: 14px;
    color: #6b7280;
    font-weight: 500;
  }

  .store-address {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    margin-bottom: 12px;
    color: #4b5563;
  }

  .store-address svg {
    flex-shrink: 0;
    margin-top: 2px;
  }

  .store-description {
    color: #6b7280;
    line-height: 1.6;
    margin-bottom: 20px;
  }

  .store-actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }

  .store-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.2s;
  }

  .store-btn--whatsapp {
    background: #25d366;
    color: white;
  }

  .store-btn--whatsapp:hover {
    background: #1eb757;
    transform: translateY(-1px);
  }

  .store-btn--directions {
    background: #f3f4f6;
    color: #374151;
    border: 1px solid #d1d5db;
  }

  .store-btn--directions:hover {
    background: #e5e7eb;
    transform: translateY(-1px);
  }

  @media (max-width: 749px) {
    .stores-finder {
      margin: 24px 0;
    }

    .store-card {
      padding: 20px;
    }

    .store-name {
      font-size: 20px;
    }

    .store-actions {
      flex-direction: column;
    }

    .store-btn {
      width: 100%;
      justify-content: center;
    }
  }
</style>

<script>
  (function () {
    const sectionId = '{{ section.id }}';
    const params = new URLSearchParams(window.location.search);
    const userCEP = params.get('cep');
    const userCity = params.get('cidade');
    const userNeighborhood = params.get('bairro');

    if (userCEP) {
      const cepInfo = document.getElementById('cep-info-' + sectionId);
      const locationSpan = document.getElementById('user-location-' + sectionId);

      let locationText = userCEP;
      if (userNeighborhood) locationText += ' - ' + userNeighborhood;
      if (userCity) locationText += ', ' + userCity;

      locationSpan.textContent = locationText;
      cepInfo.style.display = 'block';

      fetch('https://viacep.com.br/ws/' + userCEP + '/json/')
        .then((res) => res.json())
        .then((data) => {
          if (!data.erro) {
            const userLat = -20.67;
            const userLng = -40.5;
            calculateAndSortDistances(userLat, userLng);
          }
        })
        .catch((err) => console.error('Erro:', err));
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function toRad(degrees) {
      return degrees * (Math.PI / 180);
    }

    function calculateAndSortDistances(userLat, userLng) {
      const storeCards = document.querySelectorAll('#stores-list-' + sectionId + ' .store-card');
      const stores = [];

      storeCards.forEach((card) => {
        const lat = parseFloat(card.dataset.lat);
        const lng = parseFloat(card.dataset.lng);
        const distance = calculateDistance(userLat, userLng, lat, lng);
        stores.push({ card, distance });
      });

      stores.sort((a, b) => a.distance - b.distance);

      stores.forEach((store, index) => {
        const badge = store.card.querySelector('.store-badge');
        const distanceSpan = store.card.querySelector('.store-distance');

        badge.style.display = 'flex';
        distanceSpan.textContent = store.distance.toFixed(1) + ' km';

        if (index === 0) {
          store.card.classList.add('nearest');
          distanceSpan.textContent = 'Mais próxima: ' + store.distance.toFixed(1) + ' km';
        }

        document.getElementById('stores-list-' + sectionId).appendChild(store.card);
      });
    }
  })();
</script>

{% schema %}
{
  "name": "Nossas Lojas",
  "settings": [],
  "presets": [
    {
      "name": "Nossas Lojas"
    }
  ]
}
{% endschema %}
