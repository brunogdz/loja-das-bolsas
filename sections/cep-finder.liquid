{%- assign sid = section.id | replace: '_', '' | downcase -%}

{% style %}
  /* ===== CONTÊINER ===== */
  .cep-finder-{{ sid }} {
    width: 100%;
    padding: 40px 20px;
    background: {{ section.settings.bg_color }};
  }

  .cep-inner-{{ sid }} {
    max-width: 1320px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
  }

  /* ===== HEADER COM ÍCONE ===== */
  .cep-header-{{ sid }} {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .cep-icon-{{ sid }} {
    width: 21px;
    height: 22px;
    flex-shrink: 0;
  }

  .cep-title-{{ sid }} {
    margin: 0;
    font-size: {{ section.settings.title_size }}px;
    font-weight: 700;
    color: {{ section.settings.title_color }};
    line-height: 1.2;
  }

  .cep-subtitle-{{ sid }} {
    font-size: {{ section.settings.subtitle_size }}px;
    font-weight: 400;
    color: {{ section.settings.subtitle_color }};
    margin-left: 4px;
  }

  /* ===== CAMPO DE BUSCA ===== */
  .cep-search-wrapper-{{ sid }} {
    position: relative;
    width: 100%;
    max-width: 1000px;
  }

  .cep-input-{{ sid }} {
    width: 100%;
    height: 56px;
    padding: 0 60px 0 24px;
    border: none;
    border-radius: 28px;
    background: {{ section.settings.input_bg }};
    font-size: 16px;
    color: {{ section.settings.input_text_color }};
    outline: none;
    transition: all 0.2s;
  }

  .cep-input-{{ sid }}::placeholder {
    color: {{ section.settings.placeholder_color }};
  }

  .cep-input-{{ sid }}:focus {
    box-shadow: 0 0 0 2px {{ section.settings.input_focus_color }};
  }

  .cep-search-btn-{{ sid }} {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    width: 40px;
    height: 40px;
    border: none;
    border-radius: 50%;
    background: transparent;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
  }

  .cep-search-btn-{{ sid }}:hover {
    background: rgba(0, 0, 0, 0.05);
  }

  .cep-search-btn-{{ sid }}:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .cep-search-btn-{{ sid }} svg {
    width: 20px;
    height: 20px;
  }

  /* Loading spinner */
  .cep-loading-{{ sid }} {
    display: none;
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    width: 24px;
    height: 24px;
    border: 3px solid {{ section.settings.placeholder_color }};
    border-top-color: {{ section.settings.input_focus_color }};
    border-radius: 50%;
    animation: spin-{{ sid }} 0.8s linear infinite;
  }

  .cep-loading-{{ sid }}.active {
    display: block;
  }

  @keyframes spin-{{ sid }} {
    to { transform: translateY(-50%) rotate(360deg); }
  }

  /* Mensagem de erro */
  .cep-error-{{ sid }} {
    display: none;
    color: #dc2626;
    font-size: 14px;
    margin-top: 8px;
    text-align: center;
  }

  .cep-error-{{ sid }}.active {
    display: block;
  }

  /* ===== RESPONSIVO MOBILE ===== */
  @media (max-width: 749px) {
    .cep-finder-{{ sid }} {
      padding: 30px 16px;
    }

    .cep-header-{{ sid }} {
      flex-direction: column;
      gap: 8px;
      text-align: center;
    }

    .cep-icon-{{ sid }} {
      margin-bottom: 4px;
    }

    .cep-title-{{ sid }} {
      font-size: {{ section.settings.title_size_mobile }}px;
    }

    .cep-subtitle-{{ sid }} {
      font-size: {{ section.settings.subtitle_size_mobile }}px;
      margin-left: 0;
      display: block;
    }

    .cep-input-{{ sid }} {
      height: 48px;
      font-size: 14px;
      padding: 0 50px 0 20px;
    }
  }
{% endstyle %}

<section class="cep-finder-{{ sid }}" {{ section.shopify_attributes }}>
  <div class="cep-inner-{{ sid }}">
    <div class="cep-header-{{ sid }}">
      <svg class="cep-icon-{{ sid }}" viewBox="0 0 21 22" fill="none" xmlns="http://www.w3.org/2000/svg">
        <g clip-path="url(#clip0_{{ sid }})">
          <path d="M17.75 8.875C17.75 15 9.875 20.25 9.875 20.25C9.875 20.25 2 15 2 8.875C2 6.78642 2.82969 4.78338 4.30653 3.30653C5.78338 1.82969 7.78642 1 9.875 1C11.9636 1 13.9666 1.82969 15.4435 3.30653C16.9203 4.78338 17.75 6.78642 17.75 8.875Z" stroke="{{ section.settings.icon_color }}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M10.5 11.5107C11.9497 11.5107 13.125 10.3215 13.125 8.85449C13.125 7.38749 11.9497 6.19824 10.5 6.19824C9.05025 6.19824 7.875 7.38749 7.875 8.85449C7.875 10.3215 9.05025 11.5107 10.5 11.5107Z" stroke="{{ section.settings.icon_color }}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </g>
        <defs>
          <clipPath id="clip0_{{ sid }}">
            <rect width="21" height="21.25" fill="white"/>
          </clipPath>
        </defs>
      </svg>
      <h2 class="cep-title-{{ sid }}">
        {{ section.settings.title }}
        <span class="cep-subtitle-{{ sid }}">{{ section.settings.subtitle }}</span>
      </h2>
    </div>

    <div class="cep-search-wrapper-{{ sid }}">
      <input 
        type="text" 
        class="cep-input-{{ sid }}" 
        placeholder="{{ section.settings.placeholder }}"
        id="cep-input-{{ sid }}"
        maxlength="9"
        autocomplete="postal-code"
      >
      <button type="button" class="cep-search-btn-{{ sid }}" id="cep-btn-{{ sid }}" aria-label="Buscar CEP">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M9 17C13.4183 17 17 13.4183 17 9C17 4.58172 13.4183 1 9 1C4.58172 1 1 4.58172 1 9C1 13.4183 4.58172 17 9 17Z" stroke="{{ section.settings.search_icon_color }}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M19 19L14.65 14.65" stroke="{{ section.settings.search_icon_color }}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <div class="cep-loading-{{ sid }}" id="cep-loading-{{ sid }}"></div>
      <div class="cep-error-{{ sid }}" id="cep-error-{{ sid }}"></div>
    </div>
  </div>
</section>

<script>
(function() {
  const input = document.getElementById('cep-input-{{ sid }}');
  const button = document.getElementById('cep-btn-{{ sid }}');
  const loading = document.getElementById('cep-loading-{{ sid }}');
  const errorMsg = document.getElementById('cep-error-{{ sid }}');

  if (input) {
    input.addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 5) {
        value = value.slice(0, 5) + '-' + value.slice(5, 8);
      }
      e.target.value = value;
      hideError();
    });

    input.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        searchCEP();
      }
    });
  }

  if (button) {
    button.addEventListener('click', searchCEP);
  }

  function showLoading() {
    loading.classList.add('active');
    button.disabled = true;
    button.style.opacity = '0';
  }

  function hideLoading() {
    loading.classList.remove('active');
    button.disabled = false;
    button.style.opacity = '1';
  }

  function showError(message) {
    errorMsg.textContent = message;
    errorMsg.classList.add('active');
  }

  function hideError() {
    errorMsg.classList.remove('active');
  }

  function searchCEP() {
    const cep = input.value.replace(/\D/g, '');
    
    if (cep.length !== 8) {
      showError('Por favor, digite um CEP válido com 8 dígitos');
      input.focus();
      return;
    }

    showLoading();
    hideError();

    fetch(`https://viacep.com.br/ws/${cep}/json/`)
      .then(response => {
        if (!response.ok) {
          throw new Error('Erro na busca do CEP');
        }
        return response.json();
      })
      .then(data => {
        hideLoading();
        
        if (data.erro) {
          showError('CEP não encontrado. Verifique e tente novamente.');
          input.focus();
          return;
        }

        const params = new URLSearchParams({
          cep: cep,
          cidade: data.localidade || '',
          bairro: data.bairro || '',
          uf: data.uf || '',
          logradouro: data.logradouro || ''
        });

        window.location.href = `/pages/nossas-lojas?${params.toString()}`;
      })
      .catch(error => {
        hideLoading();
        console.error('Erro:', error);
        showError('Erro ao buscar CEP. Tente novamente.');
      });
  }
})();
</script>

{% schema %}
{
  "name": "CEP Finder",
  "settings": [
    {
      "type": "header",
      "content": "Textos"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Título",
      "default": "Loja das Bolsas"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subtítulo",
      "default": "perto de mim"
    },
    {
      "type": "text",
      "id": "placeholder",
      "label": "Placeholder do campo",
      "default": "Buscar por CEP"
    },
    {
      "type": "header",
      "content": "Tamanhos (Desktop)"
    },
    {
      "type": "range",
      "id": "title_size",
      "label": "Tamanho do título",
      "min": 16,
      "max": 48,
      "step": 1,
      "default": 32
    },
    {
      "type": "range",
      "id": "subtitle_size",
      "label": "Tamanho do subtítulo",
      "min": 14,
      "max": 32,
      "step": 1,
      "default": 24
    },
    {
      "type": "header",
      "content": "Tamanhos (Mobile)"
    },
    {
      "type": "range",
      "id": "title_size_mobile",
      "label": "Tamanho do título mobile",
      "min": 14,
      "max": 32,
      "step": 1,
      "default": 20
    },
    {
      "type": "range",
      "id": "subtitle_size_mobile",
      "label": "Tamanho do subtítulo mobile",
      "min": 12,
      "max": 24,
      "step": 1,
      "default": 16
    },
    {
      "type": "header",
      "content": "Cores"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Cor de fundo",
      "default": "#FFFFFF"
    },
    {
      "type": "color",
      "id": "icon_color",
      "label": "Cor do ícone",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Cor do título",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "subtitle_color",
      "label": "Cor do subtítulo",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "input_bg",
      "label": "Fundo do campo de busca",
      "default": "#E5E5E5"
    },
    {
      "type": "color",
      "id": "input_text_color",
      "label": "Cor do texto do campo",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "placeholder_color",
      "label": "Cor do placeholder",
      "default": "#666666"
    },
    {
      "type": "color",
      "id": "input_focus_color",
      "label": "Cor do foco do campo",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "search_icon_color",
      "label": "Cor do ícone de busca",
      "default": "#000000"
    }
  ],
  "presets": [
    {
      "name": "CEP Finder"
    }
  ]
}
{% endschema %}